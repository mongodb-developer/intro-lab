"use strict";(self.webpackChunkintro_lab=self.webpackChunkintro_lab||[]).push([["2462"],{2418:function(e,t,n){n.r(t),n.d(t,{frontMatter:()=>l,toc:()=>u,default:()=>p,metadata:()=>o,assets:()=>c,contentTitle:()=>d});var o=JSON.parse('{"id":"optimize/patterns","title":"\u{1F4D8} Patterns Used","description":"Let\'s look at the current code that is used to retrieve a single book. You can find this code in the server/src/controllers/books.ts file.","source":"@site/docs/75-optimize/2-patterns.mdx","sourceDirName":"75-optimize","slug":"/optimize/patterns","permalink":"/intro-lab/docs/optimize/patterns","draft":false,"unlisted":false,"editUrl":"https://github.com/mongodb-developer/intro-lab/blob/main/docs/75-optimize/2-patterns.mdx","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"\u{1F4D8} Intro","permalink":"/intro-lab/docs/optimize/intro"},"next":{"title":"\u{1F450} Optimize the Query","permalink":"/intro-lab/docs/optimize/optimize"}}'),r=n(5893),i=n(65),a=n(7902),s=n(5525);let l={},d="\u{1F4D8} Patterns Used",c={},u=[{value:"Available books - computed",id:"available-books---computed",level:2},{value:"Reviews - subset",id:"reviews---subset",level:2},{value:"Author - extended reference",id:"author---extended-reference",level:2}];function h(e){let t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"-patterns-used",children:"\u{1F4D8} Patterns Used"})}),"\n",(0,r.jsxs)(a.Z,{groupId:"server",children:[(0,r.jsxs)(s.Z,{value:"node",label:"\u{1F680} NodeJS/Express",children:[(0,r.jsxs)(t.p,{children:["Let's look at the current code that is used to retrieve a single book. You can find this code in the ",(0,r.jsx)(t.code,{children:"server/src/controllers/books.ts"})," file."]}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-ts",children:"    public async getBook(bookId: string): Promise<Book> {\n        /**\n         * Initial Code\n         * Task: Optimise the query to take advantage of the already computed field.\n         * Hint: Take a look at the shape of the Book documents using MongoDB Compass.\n         */\n        const books = await collections?.books?.aggregate<Book>([\n            {\n                $match: {\n                    _id: bookId\n                },\n            },\n            {\n                $lookup: {\n                    from: 'issueDetails',\n                    localField: '_id',\n                    foreignField: 'book._id',\n                    pipeline: [\n                        {\n                            $match: {\n                                $or: [\n                                    { recordType: 'reservation' },\n                                    { recordType: 'borrowedBook', returned: false }\n                                ]\n                            }\n                        }\n                    ],\n                    as: 'details'\n                }\n            },\n            {\n                $set: {\n                    available: {\n                        $subtract: ['$totalInventory', { $size: '$details' }]\n                    }\n                }\n            },\n            {\n                $unset: 'details'\n            },\n        ]).toArray();\n\n        if (!books?.length) {\n            return;\n        }\n\n        return books[0];\n    }\n"})}),(0,r.jsx)(t.p,{children:"That's a lot of code! That's because the developer who wrote this used MongoDB just like a relational database. Let's break it down into a few pieces."}),(0,r.jsx)(t.p,{children:"First, it uses an aggregation pipeline. Don't worry too much about this \u2014 you'll learn more about it this afternoon."}),(0,r.jsxs)(t.p,{children:["The first stage uses a ",(0,r.jsx)(t.code,{children:"$match"})," stage to filter the documents by the ",(0,r.jsx)(t.code,{children:"_id"})," field. This is the equivalent of a ",(0,r.jsx)(t.code,{children:"WHERE"})," clause in SQL. This operation is really fast because the ",(0,r.jsx)(t.code,{children:"_id"})," field is indexed automatically."]}),(0,r.jsxs)(t.p,{children:["The second stage uses a ",(0,r.jsx)(t.code,{children:"$lookup"})," stage to join the ",(0,r.jsx)(t.code,{children:"issueDetails"})," collection to the ",(0,r.jsx)(t.code,{children:"books"})," collection. This is the equivalent of a ",(0,r.jsx)(t.code,{children:"JOIN"})," in SQL. This operation is really slow because it has to scan the entire ",(0,r.jsx)(t.code,{children:"issueDetails"})," collection to find the matching documents. It could be improved by adding an index on the ",(0,r.jsx)(t.code,{children:"bookId"})," field of the ",(0,r.jsx)(t.code,{children:"issueDetails"})," collection, but too many indexes can consume valuable resources."]}),(0,r.jsx)(t.p,{children:"The third and fourth stages compute the number of available books by subtracting the number of issued books from the total inventory."}),(0,r.jsx)(t.p,{children:"At this point, we also have to do additional queries to display the first five reviews for a book and the author information. This means that we have to do three queries to display a single book."})]}),(0,r.jsxs)(s.Z,{value:"java",label:"\u2615\uFE0F Java Spring Boot",children:[(0,r.jsxs)(t.p,{children:["Let's look at the current code that is used to retrieve a single book.\nOpen the ",(0,r.jsx)(t.a,{href:"https://github.com/mongodb-developer/library-management-system/blob/java-server/java-server/src/main/java/com/mongodb/devrel/library/domain/service/BookService.java",children:(0,r.jsx)(t.code,{children:"BookService"})})," class and check the ",(0,r.jsx)(t.code,{children:"getBook"})," method:"]}),(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-java",metastring:"title='src/main/java/com/mongodb/devrel/library/domain/service/BookService.java'",children:' public Optional<Book> getBook(String id) {\n        Aggregation aggregation = Aggregation.newAggregation(\n                Aggregation.match(Criteria.where("_id").is(id)),\n                LookupOperation.newLookup()\n                        .from("issueDetails")\n                        .localField("_id")\n                        .foreignField("book._id")\n                        .pipeline(\n                                Aggregation.match(new Criteria().orOperator(\n                                        Criteria.where("recordType").is("reservation"),\n                                        Criteria.where("recordType").is("borrowedBook").and("returned").is(false)\n                                ))\n                        )\n                        .as("details"),\n                Aggregation.addFields()\n                        .addFieldWithValue("available",\n                                new Document("$subtract", Arrays.asList("$totalInventory", new Document("$size", "$details"))))\n                        .build(),\n                Aggregation.project().andExclude("details")\n        );\n\n        AggregationResults<Book> results = mongoTemplate.aggregate(aggregation, "books", Book.class);\n\n        return results.getMappedResults().stream().findFirst();\n    }\n\n'})}),(0,r.jsx)(t.p,{children:"The method does the following:"}),(0,r.jsxs)(t.ol,{children:["\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Aggregation.match"}),": filters the book by ",(0,r.jsx)(t.code,{children:"_id"})," (just like a ",(0,r.jsx)(t.code,{children:"SQL WHERE"}),")."]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"LookupOperation.newLookup()"}),": performs a join with the issueDetails collection to get related records."]}),"\n",(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsx)(t.li,{children:"Here we filter only reservations or borrowed books that haven\u2019t been returned yet."}),"\n",(0,r.jsx)(t.li,{children:"This stage is expensive because it has to scan the issueDetails collection."}),"\n"]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Aggregation.addFields()"}),": computes the available field by subtracting issued books from the total inventory."]}),"\n"]}),"\n",(0,r.jsxs)(t.li,{children:["\n",(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Aggregation.project()"}),": removes the temporary details field before returning the final result."]}),"\n"]}),"\n"]}),(0,r.jsx)(t.p,{children:"This approach works, but it\u2019s not efficient \u2014 it simulates a relational-style query in MongoDB.\nWe will later see how to apply patterns to improve this."})]})]}),"\n",(0,r.jsx)(t.p,{children:"Let's look at patterns that we can apply here to improve the performance of this query."}),"\n",(0,r.jsx)(t.h2,{id:"available-books---computed",children:"Available books - computed"}),"\n",(0,r.jsx)(t.p,{children:"The first thing we can do is to compute the number of available books when we insert or update a book. This way, we don't have to compute it every time we retrieve a book."}),"\n",(0,r.jsx)(t.p,{children:"Now that we have this computed field, we don't need all the later stages of the aggregation pipeline, and we can directly query the book collection."}),"\n",(0,r.jsx)(t.h2,{id:"reviews---subset",children:"Reviews - subset"}),"\n",(0,r.jsx)(t.p,{children:"For the reviews, we know that our users generally only look at the top five reviews. We can store the top five reviews in the book document and only query the reviews collection when we need to display more reviews."}),"\n",(0,r.jsx)(t.h2,{id:"author---extended-reference",children:"Author - extended reference"}),"\n",(0,r.jsx)(t.p,{children:"For the author information, instead of storing only the author id, we can store the id, along with the author name. This way, we don't have to query the authors collection to display the author name."})]})}function p(e={}){let{wrapper:t}={...(0,i.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},5525:function(e,t,n){n.d(t,{Z:()=>i});var o=n(5893);n(7294);var r=n(4904);function i({children:e,hidden:t,className:n}){return(0,o.jsx)("div",{role:"tabpanel",className:(0,r.Z)("tabItem_Ymn6",n),hidden:t,children:e})}},7902:function(e,t,n){n.d(t,{Z:()=>v});var o=n(5893),r=n(7294),i=n(4904),a=n(9599),s=n(6550),l=n(2e3),d=n(4520),c=n(8341),u=n(6009);function h(e){return r.Children.toArray(e).filter(e=>"\n"!==e).map(e=>{if(!e||(0,r.isValidElement)(e)&&function(e){let{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)})?.filter(Boolean)??[]}function p({value:e,tabValues:t}){return t.some(t=>t.value===e)}var m=n(7227);function b({className:e,block:t,selectedValue:n,selectValue:r,tabValues:s}){let l=[],{blockElementScrollPositionUntilNextRender:d}=(0,a.o5)(),c=e=>{let t=e.currentTarget,o=s[l.indexOf(t)].value;o!==n&&(d(t),r(o))},u=e=>{let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{let n=l.indexOf(e.currentTarget)+1;t=l[n]??l[0];break}case"ArrowLeft":{let n=l.indexOf(e.currentTarget)-1;t=l[n]??l[l.length-1]}}t?.focus()};return(0,o.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,i.Z)("tabs",{"tabs--block":t},e),children:s.map(({value:e,label:t,attributes:r})=>(0,o.jsx)("li",{role:"tab",tabIndex:n===e?0:-1,"aria-selected":n===e,ref:e=>{l.push(e)},onKeyDown:u,onClick:c,...r,className:(0,i.Z)("tabs__item","tabItem_LNqP",r?.className,{"tabs__item--active":n===e}),children:t??e},e))})}function f({lazy:e,children:t,selectedValue:n}){let a=(Array.isArray(t)?t:[t]).filter(Boolean);if(e){let e=a.find(e=>e.props.value===n);return e?(0,r.cloneElement)(e,{className:(0,i.Z)("margin-top--md",e.props.className)}):null}return(0,o.jsx)("div",{className:"margin-top--md",children:a.map((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==n}))})}function g(e){let t=function(e){let{defaultValue:t,queryString:n=!1,groupId:o}=e,i=function(e){let{values:t,children:n}=e;return(0,r.useMemo)(()=>{let e=t??h(n).map(({props:{value:e,label:t,attributes:n,default:o}})=>({value:e,label:t,attributes:n,default:o})),o=(0,c.lx)(e,(e,t)=>e.value===t.value);if(o.length>0)throw Error(`Docusaurus error: Duplicate values "${o.map(e=>e.value).join(", ")}" found in <Tabs>. Every value needs to be unique.`);return e},[t,n])}(e),[a,m]=(0,r.useState)(()=>(function({defaultValue:e,tabValues:t}){if(0===t.length)throw Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(e){if(!p({value:e,tabValues:t}))throw Error(`Docusaurus error: The <Tabs> has a defaultValue "${e}" but none of its children has the corresponding value. Available values are: ${t.map(e=>e.value).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return e}let n=t.find(e=>e.default)??t[0];if(!n)throw Error("Unexpected error: 0 tabValues");return n.value})({defaultValue:t,tabValues:i})),[b,f]=function({queryString:e=!1,groupId:t}){let n=(0,s.k6)(),o=function({queryString:e=!1,groupId:t}){if("string"==typeof e)return e;if(!1===e)return null;if(!0===e&&!t)throw Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return t??null}({queryString:e,groupId:t});return[(0,d._X)(o),(0,r.useCallback)(e=>{if(!o)return;let t=new URLSearchParams(n.location.search);t.set(o,e),n.replace({...n.location,search:t.toString()})},[o,n])]}({queryString:n,groupId:o}),[g,v]=function({groupId:e}){let t=e?`docusaurus.tab.${e}`:null,[n,o]=(0,u.Nk)(t);return[n,(0,r.useCallback)(e=>{t&&o.set(e)},[t,o])]}({groupId:o}),x=(()=>{let e=b??g;return p({value:e,tabValues:i})?e:null})();return(0,l.Z)(()=>{x&&m(x)},[x]),{selectedValue:a,selectValue:(0,r.useCallback)(e=>{if(!p({value:e,tabValues:i}))throw Error(`Can't select invalid tab value=${e}`);m(e),f(e),v(e)},[f,v,i]),tabValues:i}}(e);return(0,o.jsxs)("div",{className:(0,i.Z)("tabs-container","tabList__CuJ"),children:[(0,o.jsx)(b,{...t,...e}),(0,o.jsx)(f,{...t,...e})]})}function v(e){let t=(0,m.Z)();return(0,o.jsx)(g,{...e,children:h(e.children)},String(t))}},65:function(e,t,n){n.d(t,{Z:()=>s,a:()=>a});var o=n(7294);let r={},i=o.createContext(r);function a(e){let t=o.useContext(i);return o.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function s(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:a(e.components),o.createElement(i.Provider,{value:t},e.children)}}}]);