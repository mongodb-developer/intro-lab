# ğŸ‘ ä¸º users é›†åˆå¯ç”¨éªŒè¯

åœ¨æœ¬ç»ƒä¹ ä¸­ï¼Œæ‚¨å°†æ¢ç´¢ pre-written çš„ `users` é›†åˆçš„ JSON æ¨¡å‹æ ¡éªŒï¼Œè¿è¡Œè„šæœ¬å°†å…¶åº”ç”¨äºé›†åˆï¼Œå¹¶é€šè¿‡æ’å…¥ä¸ç¬¦åˆæ¨¡å‹å®šä¹‰çš„æ–‡æ¡£æ¥æµ‹è¯•æ¨¡å‹æ ¡éªŒã€‚

## æ•°æ®åº“ç”¨æˆ·æƒé™ {#database-user-permissions}

è¦æ›´æ–°ä»»ä½•æ•°æ®åº“é›†åˆçš„éªŒè¯å™¨ï¼Œæ‚¨çš„æ•°æ®åº“ç”¨æˆ·å¿…é¡»å…·æœ‰ç®¡ç†å‘˜æƒé™ã€‚è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤ç¡®ä¿æ‚¨çš„ç”¨æˆ·å…·æœ‰æ­£ç¡®çš„æƒé™ï¼š

1. æ‰“å¼€ [Atlas UI](https://cloud.mongodb.com?utm_campaign=devrel&utm_source=workshop&utm_medium=cta&utm_content=developer.day&utm_term=project.phoenix)ã€‚
2. åœ¨å·¦ä¾§èœå•ä¸­ï¼Œå¯¼èˆªåˆ° **Network Settings** å¹¶é€‰æ‹© **Database Access**ã€‚
3. åœ¨åˆ—è¡¨ä¸­æ‰¾åˆ°æ‚¨çš„æ•°æ®åº“ç”¨æˆ·ã€‚æ£€æŸ¥ **MongoDB Roles** åˆ—ä¸­ç”¨æˆ·çš„è§’è‰²ã€‚å¦‚æœè§’è‰²ä¸æ˜¯ **atlasAdmin@admin**ï¼Œæ‚¨éœ€è¦æ›´æ–°å®ƒã€‚
4. å¦‚æœè§’è‰²ä¸æ˜¯ **atlasAdmin@admin**ï¼Œè¯·ç‚¹å‡»ç”¨æˆ·æ—è¾¹çš„ **Edit** æŒ‰é’®ã€‚
5. å‘ä¸‹æ»šåŠ¨åˆ° **Database User Privileges** éƒ¨åˆ†å¹¶å±•å¼€ **Built-in Role** ä¸‹æ‹‰èœå•ã€‚
6. ä»ä¸‹æ‹‰èœå•ä¸­é€‰æ‹© **Atlas admin**ã€‚
7. ç‚¹å‡» **Update User** ä¿å­˜æ›´æ”¹ã€‚

Atlas ä¼šåœ¨å‡ ç§’é’Ÿå†…éƒ¨ç½²æ›´æ”¹ã€‚

## æ¢ç´¢ JSON æ¨¡å¼

`users` é›†åˆçš„ JSON æ¨¡å¼å­˜å‚¨åœ¨ `server/src/schema-validation/apply-schema.ts` [æ–‡ä»¶](https://github.com/mongodb-developer/library-management-system/blob/main/server/src/schema-validation/apply-schema.ts)ä¸­ã€‚åœ¨æ‚¨çš„ GitHub Codespace ä¸­æ‰“å¼€è¯¥æ–‡ä»¶å¹¶æ£€æŸ¥æ¨¡å¼ã€‚

```ts
const userSchema = {
    bsonType: 'object',
    required: ['name', 'isAdmin'],
    properties: {
        name: {
            bsonType: 'string',
            minLength: 5,
            description: 'must be a string and is required'
        },
        isAdmin: {
            bsonType: 'bool',
            description: 'must be a boolean and is required'
        }
    }
};
```

è¯¥æ¨¡å¼å®šä¹‰äº†ä»¥ä¸‹çº¦æŸï¼š
- å¿…å¡«å­—æ®µæ˜¯ `name` å’Œ `isAdmin`ã€‚
- `name` å­—æ®µå¿…é¡»æ˜¯é•¿åº¦è‡³å°‘ä¸º 5 ä¸ªå­—ç¬¦çš„å­—ç¬¦ä¸²ã€‚
- `isAdmin` å­—æ®µå¿…é¡»æ˜¯å¸ƒå°”å€¼ã€‚

## æ¢ç´¢åº”ç”¨æ¨¡å¼çš„è„šæœ¬

æ£€æŸ¥ `apply-schema.ts` æ–‡ä»¶ä¸­æ¨¡å¼å®šä¹‰ä¹‹åçš„ä»£ç è¡Œã€‚æ‚¨å°†çœ‹åˆ°ä¸€ä¸ªå°†æ¨¡å¼åº”ç”¨äº `users` é›†åˆçš„å‡½æ•°ã€‚

```ts
console.log('Applying schema validation for users...');
const resultUsers = await db.command({
    collMod: 'users',
    validator: {
        $jsonSchema: userSchema
    },
    validationLevel: 'strict',
    validationAction: 'error'
});
```

è¯¥å‡½æ•°ä½¿ç”¨ `db.command()` æ–¹æ³•å°†æ¨¡å¼åº”ç”¨äº `users` é›†åˆã€‚
- `collMod` é€‰é¡¹æŒ‡å®šè¦åº”ç”¨æ¨¡å¼çš„é›†åˆã€‚
- `validator` é€‰é¡¹æŒ‡å®šç”¨äºéªŒè¯çš„ JSON æ¨¡å¼ã€‚è¿™æ˜¯ä¸Šé¢å£°æ˜çš„ `userSchema` å¯¹è±¡ã€‚
- `validationLevel` é€‰é¡¹æŒ‡å®šè¦æ‰§è¡Œçš„éªŒè¯çº§åˆ«ã€‚è¿™å¯ä»¥æ˜¯ `strict` æˆ– `moderate`ã€‚
    - å¦‚æœè®¾ç½®ä¸º `strict`ï¼Œæ–‡æ¡£åªæœ‰åœ¨é€šè¿‡éªŒè¯æ—¶æ‰ä¼šè¢«æ’å…¥å’Œæ›´æ–°ã€‚
    - å¦‚æœè®¾ç½®ä¸º `moderate`ï¼Œé›†åˆä¸­ç°æœ‰æ–‡æ¡£çš„æ›´æ–°å°†ä¸æ£€æŸ¥å…¶æ˜¯å¦ç¬¦åˆéªŒè¯è§„åˆ™ã€‚
- æœ€åï¼Œ`validationAction` é€‰é¡¹æŒ‡å®šåœ¨æ–‡æ¡£éªŒè¯å¤±è´¥æ—¶é‡‡å–çš„æ“ä½œã€‚è¿™å¯ä»¥æ˜¯ `error` æˆ– `warn`ã€‚
    - å¦‚æœè®¾ç½®ä¸º `error`ï¼ŒMongoDB ä¼šæ‹’ç»ä»»ä½•è¿åéªŒè¯æ ‡å‡†çš„æ’å…¥æˆ–æ›´æ–°ã€‚
    - å¦‚æœè®¾ç½®ä¸º `warn`ï¼Œæ“ä½œä¼šç»§ç»­è¿›è¡Œï¼Œä½†è¿è§„è¡Œä¸ºä¼šè®°å½•åœ¨ MongoDB æ—¥å¿—ä¸­ã€‚

## å°†æ¨¡å‹åº”ç”¨äº `users` é›†åˆ

æ‚¨éœ€è¦è¿è¡Œè„šæœ¬å°†æ¨¡å‹åº”ç”¨äº `users` é›†åˆã€‚

1. åœ¨æ‚¨çš„ GitHub Codespace ä¸­æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ä»¿çœŸå™¨æ ‡ç­¾ã€‚
    1. å®šä½åº•éƒ¨é¢æ¿å¹¶ç‚¹å‡» `TERMINAL` æ ‡ç­¾ã€‚
    1. å®šä½ç»ˆç«¯é¢æ¿å³ä¸Šè§’çš„ `+` å›¾æ ‡ï¼Œç‚¹å‡»å®ƒæ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯æ ‡ç­¾ã€‚
    1. ç‚¹å‡»æ–°çš„ç»ˆç«¯æ ‡ç­¾æ¿€æ´»å®ƒã€‚

1. è¿è¡Œä»¥ä¸‹å‘½ä»¤å°†æ¨¡å¼åº”ç”¨äº `users` é›†åˆï¼š

    ```
    cd server
    node dist/schema-validation/apply-schema.js 
    ```

    æ‚¨å¯èƒ½ä¼šè¢«æç¤ºå…è®¸ç²˜è´´åˆ°ç»ˆç«¯ã€‚ç‚¹å‡» **Allow** ä»¥ç²˜è´´å‘½ä»¤ã€‚

    æŒ‰å›è½¦é”®è¿è¡Œå‘½ä»¤ã€‚å‡ ç§’é’Ÿåï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä»¥ä¸‹è¾“å‡ºï¼š

    ```
    Connecting to MongoDB Atlas...
    Connected!

    Applying schema validation for users...
    Schema validation enabled!
    ```

:::caution
å¦‚æœæ‚¨çœ‹åˆ°ä¸ç”¨æˆ·æƒé™ç›¸å…³çš„é”™è¯¯ï¼Œè¯·è¿”å›åˆ°[æ•°æ®åº“ç”¨æˆ·æƒé™](#database-user-permissions)éƒ¨åˆ†å¹¶æ›´æ–°æ‚¨çš„ç”¨æˆ·æƒé™ã€‚
:::

## æµ‹è¯•æ¨¡å‹éªŒè¯

ç°åœ¨å·²ç»ä¸º `users` é›†åˆå¯ç”¨äº†æ¨¡å‹æ ¡éªŒï¼Œæ‚¨å¯ä»¥é€šè¿‡æ’å…¥ä¸ç¬¦åˆæ¨¡å‹çš„æ–‡æ¡£æ¥æµ‹è¯•å®ƒã€‚

1. æ‰“å¼€ [Atlas UI](https://cloud.mongodb.com?utm_campaign=devrel&utm_source=workshop&utm_medium=cta&utm_content=developer.day&utm_term=project.phoenix)ã€‚
1. åœ¨æ‚¨çš„é›†ç¾¤ä¸‹ç‚¹å‡» **Browse Collections**ã€‚
1. å¯¼èˆªåˆ° `users` é›†åˆ â€”â€” å®ƒæ˜¯åˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ªé›†åˆã€‚
1. ç‚¹å‡»å³ä¾§çš„ **Insert Document** æŒ‰é’®ï¼Œç„¶åç‚¹å‡» **Insert**ã€‚

æ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä¸€æ¡é”™è¯¯æ¶ˆæ¯ã€‚åœ¨é”™è¯¯æ¶ˆæ¯çš„æœ€åº•éƒ¨ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°ä»¥ä¸‹å†…å®¹ï¼š

```
"schemaRulesNotSatisfied": [{
    "operatorName": "required",
    "specifiedAs": {"required": ["name","isAdmin"]},
    "missingProperties": ["isAdmin","name"]
}]
```

é”™è¯¯æè¿°äº† `name` å’Œ `isAdmin` å­—æ®µæ˜¯å¿…éœ€çš„ï¼Œä½†åœ¨æ‚¨å°è¯•æ’å…¥çš„æ–‡æ¡£ä¸­ç¼ºå¤±äº†è¿™äº›å­—æ®µã€‚

å†æ¬¡æ’å…¥åŒ…å« `name` å’Œ `isAdmin` å­—æ®µçš„æ–‡æ¡£ï¼Œæ‚¨åº”è¯¥ä¼šçœ‹åˆ°æ–‡æ¡£æˆåŠŸæ’å…¥ã€‚

## æ€»ç»“

åœ¨è¿™ä¸ªç»ƒä¹ ä¸­ï¼Œæ‚¨æ¢ç´¢äº† `users` é›†åˆçš„ JSON æ¨¡å‹ï¼Œè¿è¡Œäº†ä¸€ä¸ªè„šæœ¬å°†æ¨¡å‹åº”ç”¨åˆ°é›†åˆï¼Œå¹¶é€šè¿‡æ’å…¥ä¸ç¬¦åˆæ¨¡å‹çš„æ–‡æ¡£æµ‹è¯•äº†æ¨¡å‹éªŒè¯ã€‚

åœ¨ä¸‹ä¸€ä¸ªç»ƒä¹ ä¸­ï¼Œæ‚¨å°†ä¸º `authors` é›†åˆå¯ç”¨æ¨¡å‹éªŒè¯ã€‚