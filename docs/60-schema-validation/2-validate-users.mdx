import Screenshot from "@site/src/components/Screenshot";
import Tabs from '@theme/Tabs';
import TabItem from '@theme/TabItem';

#  üëê Enable Validation for the Users Collection

In this exercise, you will explore the pre-written JSON validation schema for the `users` collection, run a script to apply it to the collection, and test the schema validation by inserting a document that does not match the schema.

## Database user permissions

To update the validator for any database collection, your database user must have admin privileges. Follow these steps to ensure your user has the correct permissions:

1. Open the [Atlas UI](https://cloud.mongodb.com?utm_campaign=devrel&utm_source=workshop&utm_medium=cta&utm_content=developer.day&utm_term=project.phoenix).
2. In the left-hand menu, navigate to **Network Settings** and select "Database Access."
3. Locate your database user in the list. Check the **MongoDB Roles** column for the role of the user you are using for this workshop. If the role is not **atlasAdmin@admin**, you will need to update it.
4. If the role is not **atlasAdmin@admin**, click "Edit" button next to the user.
5. Scroll down to the **Database User Privileges** section and expand the **Built-in Role** dropdown.
6. Select "Atlas admin" from the dropdown menu.
7. Click "Update User" to save the changes.

Atlas will deploy the change in a few seconds.

## Explore the JSON schema

<Tabs groupId="server">
<TabItem value="node" label="üöÄ NodeJS/Express">

The JSON schema for the `users` collection is stored in the `server/src/schema-validation/apply-schema.ts` [file](https://github.com/mongodb-developer/library-management-system/blob/main/server/src/schema-validation/apply-schema.ts). Open the file in your GitHub codespace and examine the schema.

</TabItem>

<TabItem value="java" label="‚òïÔ∏è Java Spring Boot">

JSON schema for the `users` collection:

</TabItem>
</Tabs>

```ts
const userSchema = {
    bsonType: 'object',
    required: ['name', 'isAdmin'],
    properties: {
        name: {
            bsonType: 'string',
            minLength: 5,
            description: 'must be a string and is required'
        },
        isAdmin: {
            bsonType: 'bool',
            description: 'must be a boolean and is required'
        }
    }
};
```

The schema defines the following constraints:
- The required fields are `name` and `isAdmin`.
- The `name` field must be a string with a minimum length of five characters.
- The `isAdmin` field must be a boolean.

## Explore the script to apply the schema

<Tabs groupId="server">
<TabItem value="node" label="üöÄ NodeJS/Express">

Examine the lines immediately following the schema definition in the `apply-schema.ts` file. You will see a function that applies the schema to the `users` collection.

```js
console.log('Applying schema validation for users...');
const resultUsers = await db.command({
    collMod: 'users',
    validator: {
        $jsonSchema: userSchema
    },
    validationLevel: 'strict',
    validationAction: 'error'
});
```

The function uses the `db.command()` method to apply the schema to the `users` collection.
- The `collMod` option specifies the collection to which the schema should be applied.
- The `validator` option specifies the JSON schema to use for validation. This is the `userSchema` object declared just above.
- The `validationLevel` option specifies the level of validation to perform. This could be `strict` or `moderate`.
    - If you set it to `strict`, the document will be inserted and updated only if it passes validation.
    - If you set it to `moderate`, updates to existing documents in the collection that don't match the validation rules aren't checked for validity.
- And finally, the `validationAction` option specifies the action to take when a document fails validation. This could be `error` or `warn`.
    - If you set it to `error`, MongoDB rejects any insert or update that violates the validation criteria.
    - If you set it to `warn`, the operation proceeds, but the violation is recorded in the MongoDB log.

</TabItem>

<TabItem value="java" label="‚òïÔ∏è Java Spring Boot">
Open the file `SchemaValidationConfig.java`.

Inside this class, there are already two methods implemented:

- `applySchema` ‚Üí applies the schema validation rules to the users collection.
- `testSchema` ‚Üí tests the validation by trying to insert invalid data.


```java title='infrastructure/config/SchemaValidationConfig'
@Configuration
public class SchemaValidationConfig {

   private static final Logger log = LoggerFactory.getLogger(SchemaValidationConfig.class);
   private static final String COLLECTION_NAME = "users";

   enum SchemaMode { APPLY, TEST }

   private void applySchema(MongoDatabase db) {
       // code
   }

   private void testSchema(MongoDatabase db) {
       // code
   }

    // Others methods ..

}
```

For readability, only the class structure is shown below. 
You can open the [SchemaValidationConfig](https://github.com/mongodb-developer/library-management-system/blob/java-server/java-server/src/main/java/com/mongodb/devrel/library/infrastructure/config/SchemaValidationConfig.java) in your project to review the complete implementation.

</TabItem>
</Tabs>

## Apply the schema to the `users` collection

<Tabs groupId="server">
<TabItem value="node" label="üöÄ NodeJS/Express">

You need to run the script to apply the schema to the `users` collection.

1. Open a new terminal emulator tab in your GitHub codespace. 
    1. Locate the bottom panel and click on the `TERMINAL` tab.
    1. Locate the `+` icon on the top right of the terminal panel and click on it to open a new terminal tab.
    1. Click on the new terminal tab to activate it.

1. Run the following command to apply the schema to the `users` collection:

    ```sh
    cd server
    npx tsx src/schema-validation/apply-schema.ts

    ```

    You might be prompted to allow pasting into the terminal. Click "Allow" to paste the command.

    Click "Enter" to run the command. After a few seconds, you should see the following output:

    ```sh
    Connecting to MongoDB Atlas...
    Connected!

    Applying schema validation for users...
    Schema validation enabled!
    ```

</TabItem>

<TabItem value="java" label="‚òïÔ∏è Java Spring Boot">

The [applySchema](https://github.com/mongodb-developer/library-management-system/blob/java-server/java-server/src/main/java/com/mongodb/devrel/library/infrastructure/config/SchemaValidationConfig.java#L46) method is already implemented. 
Spring will execute it automatically thanks to [`@ConditionalOnProperty`](https://github.com/mongodb-developer/library-management-system/blob/java-server/java-server/src/main/java/com/mongodb/devrel/library/infrastructure/config/SchemaValidationConfig.java#L28), as long as we set the property value to **apply**. Stop the application if it‚Äôs running and start it again with:

```java
mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Dlab.schema-mode=apply"
```

When the application starts, you should see a message confirming that the validator was successfully applied to the users collection:
<Screenshot url="https://github.com/mongodb-developer/library-management-system" src="img/screenshots/60-schema-validation/1-schema-applied.png" alt="The schema validation applied" />


</TabItem>
</Tabs>


:::caution
If you see an error related to your user permissions, go back to the [Database User Permissions](#database-user-permissions) section and update your user permissions.
:::

## Test the schema validation

<Tabs groupId="server">
<TabItem value="node" label="üöÄ NodeJS/Express">

Now that the schema validation is enabled for the `users` collection, you can test it by inserting a document that does not match the schema.

1. Open the file `server/src/schema-validation/test-validation.ts` [file](https://github.com/mongodb-developer/library-management-system/blob/main/server/src/schema-validation/test-validation.ts).
2. Explore the call to the `insertOne()` function around line 12 that will try to insert a new user and the error handling code around line 18.
3. Execute the script by running the following command.

  ```sh
  npx tsx src/schema-validation/test-validation.ts
  ```

The error describes that the `name` and `isAdmin` fields are required but missing in the document you tried to insert.

Modify the script to insert a document again with the `name` and `isAdmin` fields and you should see the document inserted successfully.


</TabItem>

<TabItem value="java" label="‚òïÔ∏è Java Spring Boot">

The [testSchema](https://github.com/mongodb-developer/library-management-system/blob/java-server/java-server/src/main/java/com/mongodb/devrel/library/infrastructure/config/SchemaValidationConfig.java#L82) 
method is also already implemented. 

It attempts to insert a document that does not respect the schema (missing the required isAdmin field). This causes the operation to fail, proving that the schema validation is active.
To test this behavior, stop the application and run the again in validation mode by setting the property value to **test**:

```java
mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Dlab.schema-mode=test"
```

In the logs, you should see an error indicating that the insert was rejected by the validator:

<Screenshot url="https://github.com/mongodb-developer/library-management-system" src="img/screenshots/60-schema-validation/2-schema-validated.png" alt="The schema validation applied" />

</TabItem>
</Tabs>


## Summary

In this exercise, you explored the JSON schema for the `users` collection, ran a script to apply the schema to the collection, and tested the schema validation by inserting a document that does not match the schema.

In the next exercise, you will enable schema validation for the `authors` collection.
